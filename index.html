<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Freight Electrification Barriers Survey</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 100px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        h1 { color: #2c3e50; font-size: 1.5rem; }
        h2 { color: #34495e; font-size: 1.2rem; margin-top: 2.5rem; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h3 { color: #7f8c8d; font-size: 1rem; margin-top: 1.5rem; }
        
        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .sticky-header-content {
            max-width: 700px;
            margin: 0 auto;
        }
        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }
        .progress-fill {
            background: #3498db;
            height: 100%;
            transition: width 0.3s;
        }
        #progress-text {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .question-block {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .question-block.unanswered {
            border: 2px solid #e74c3c;
        }
        .question-block.locked {
            background: #f8f9fa;
            opacity: 0.8;
            position: relative;
        }
        .question-block.locked::before {
            content: 'üîí';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
            opacity: 0.5;
        }
        .question-block.locked label {
            cursor: not-allowed;
            pointer-events: none;
        }
        .question-block.locked input[type="radio"] {
            opacity: 0.5;
        }
        .question-number {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        .question-text {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .options label {
            display: block;
            padding: 10px 15px;
            margin: 5px 0;
            background: #ecf0f1;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .options label:hover { background: #d5dbdb; }
        .options input[type="radio"] { margin-right: 10px; }
        .options input[type="radio"]:checked + span { font-weight: 600; }
        
        .highlight-most { color: #2c3e50; font-weight: 600; text-decoration: underline; }
        .highlight-least { color: #2c3e50; font-weight: 600; text-decoration: underline; }

        /* .highlight-most { color: #2c3e50; font-weight: 800;}
        .highlight-least { color: #2c3e50; font-weight: 800;} */
        
        .section { margin-bottom: 40px; }
        .section-header {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .comparison-section { display: none; }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
        }
        .btn:hover { background: #2980b9; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn-next { background: #7f8c8d; }
        .btn-next:hover { background: #6c7a7d; }
        .btn-prev { background: #7f8c8d; }
        .btn-prev:hover { background: #6c7a7d; }
        .btn-reset { background: #e74c3c; }
        .btn-reset:hover { background: #c0392b; }
        .btn-start { background: #9b59b6; font-size: 1.1rem; padding: 15px 30px; }
        .btn-start:hover { background: #8e44ad; }
        .btn-submit { background: #27ae60; }
        .btn-submit:hover { background: #1e8449; }
        .btn-unlock { background: #e67e22; }
        .btn-unlock:hover { background: #d35400; }

        /* Page Navigation Styles */
        .page-indicators {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 10px;
            flex-wrap: wrap;
        }
        .page-indicator {
            width: 25px;
            height: 25px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .intro-pages { background: #9b59b6; color: white; }
        .main-page { background: #17a2b8; color: white; }
        .sub-pages { background: #5dade2; color: white; }
        .page-indicator:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .current-page {
            border: 3px solid #2c3e50;
            box-shadow: 0 0 10px rgba(44, 62, 80, 0.5);
        }
        .incomplete-page {
            outline: 3px solid #e74c3c;
            outline-offset: 2px;
        }
        .completed-page {
            outline: 3px solid #88FF0C;
            outline-offset: 0px;
        }





        /* Page Content Styles */
        .page-content {
            display: none;
            min-height: 400px;
            animation: fadeIn 0.3s ease-in;
        }
        .page-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Page Actions (Buttons Container) */
        .page-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        .page-actions .btn {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            max-width: 300px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }
        .toast.info { background: #3498db; }

        #results {
            display: none;
            background: #d5f5e3;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .error-msg {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .validation-error {
            background: #fee;
            border: 1px solid #e74c3c;
            color: #c0392b;
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        .locked-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 6px;
            border: none;
            vertical-align: middle;
        }
        .info-btn:hover { background: #2980b9; }
        
        .barrier-name { display: inline; }
        .question-text .barrier-name { text-decoration: underline; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .modal h4 { margin: 0 0 15px 0; color: #2c3e50; }
        .modal p { margin: 0 0 20px 0; color: #555; line-height: 1.6; }
        .modal-close {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal-close:hover { background: #2980b9; }
        
        .comparison-set-title {
            background: #f8f9fa;
            padding: 12px 15px;
            border-left: 4px solid #3498db;
            margin: 20px 0 15px 0;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .intro-page {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .intro-page h1 { color: #2c3e50; font-size: 1.8rem; margin-bottom: 20px; }
        .intro-page p { color: #555; margin-bottom: 15px; }
        .intro-page ul { color: #555; margin: 15px 0; padding-left: 25px; }
        .intro-page li { margin-bottom: 8px; }
        .intro-highlight {
            background: #e8f4fc;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
        }
        .intro-time {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #7f8c8d;
            margin: 20px 0;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .form-group .required { color: #e74c3c; }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        .form-group.locked input,
        .form-group.locked select,
        .form-group.locked textarea {
            background: #f8f9fa;
            cursor: not-allowed;
            pointer-events: none;
        }
        .form-group small { color: #7f8c8d; font-size: 0.85rem; }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 500px) {
            .form-row { grid-template-columns: 1fr; }
        }

        .submit-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .submit-overlay.active { display: flex; }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ecf0f1;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .submit-text {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .submit-error {
            display: none;
            background: #fee;
            border: 1px solid #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            color: #c0392b;
        }

        /* Guided Tour */
        .tour-spotlight {
            position: fixed;
            z-index: 4001;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.55);
            transition: top 0.35s ease, left 0.35s ease, width 0.35s ease, height 0.35s ease;
            pointer-events: none;
        }
        .tour-tooltip {
            position: fixed;
            z-index: 4002;
            background: white;
            border-radius: 10px;
            padding: 20px 24px;
            max-width: 360px;
            min-width: 260px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            animation: tourFadeIn 0.3s ease;
        }
        .tour-tooltip::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 10px solid transparent;
        }
        .tour-tooltip.arrow-top::before {
            bottom: 100%;
            left: 30px;
            border-bottom-color: white;
        }
        .tour-tooltip.arrow-bottom::before {
            top: 100%;
            left: 30px;
            border-top-color: white;
        }
        .tour-tooltip-step {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .tour-tooltip-text {
            font-size: 0.95rem;
            color: #2c3e50;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        .tour-tooltip-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .tour-tooltip-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .tour-tooltip-btn:hover { background: #2980b9; }
        .tour-tooltip-skip {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .tour-tooltip-skip:hover { color: #2c3e50; text-decoration: underline; }
        .tour-dots {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .tour-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #bdc3c7;
        }
        .tour-dot.active { background: #3498db; }
        @keyframes tourFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tour-highlighted {
            position: relative !important;
            z-index: 4001 !important;
        }
    </style>
</head>
<body>
    <!-- Sticky Progress Header -->
    <div class="sticky-header">
        <div class="sticky-header-content">
            <div class="page-indicators" id="page-indicators">
                <div class="page-indicator intro-pages current-page" data-page="0" onclick="navigateToPage(0)" title="Introduction">1</div>
                <div class="page-indicator intro-pages" data-page="1" onclick="navigateToPage(1)" title="Demographics">2</div>
                <div class="page-indicator main-page" data-page="2" onclick="navigateToPage(2)" title="Main Categories">3</div>
                <div class="page-indicator sub-pages" data-page="3" onclick="navigateToPage(3)" title="Economic Barriers">4</div>
                <div class="page-indicator sub-pages" data-page="4" onclick="navigateToPage(4)" title="Environmental Barriers">5</div>
                <div class="page-indicator sub-pages" data-page="5" onclick="navigateToPage(5)" title="Technological Barriers">6</div>
                <div class="page-indicator sub-pages" data-page="6" onclick="navigateToPage(6)" title="Operational Barriers">7</div>
                <div class="page-indicator sub-pages" data-page="7" onclick="navigateToPage(7)" title="Social Barriers">8</div>
                <div class="page-indicator sub-pages" data-page="8" onclick="navigateToPage(8)" title="Policy Barriers">9</div>
            </div>
        </div>
    </div>

    <!-- Submitting Overlay -->
    <div class="submit-overlay" id="submit-overlay">
        <div class="spinner"></div>
        <div class="submit-text">Submitting your responses...</div>
    </div>

<!-- SECTION 1: Introduction Page -->
    <div class="page-content active" id="page-0">
        <div class="intro-page" id="intro-page">
        <h1>üöõ Road Freight Electrification & Automation Barriers Survey</h1>
        
        <p>Thank you for participating in this research study on identifying barriers to road freight electrification and automation.</p>
        
        <div class="intro-highlight">
            <strong>Purpose of This Study</strong>
            <p style="margin-bottom:0; margin-top:10px;">This study aims to evaluate and rank barriers to the implementation of electric and automated technologies in road freight transportation. The identified barriers are classified into six categories (Economic, Environmental, Technological, Operational, Social, and Policy), each containing specific sub-barriers as shown in the figure at the bottom of the page.</p>
        </div>

        <p><strong>Survey Methodology:</strong></p>
        <p>This survey uses the <strong>Best-Worst Method (BWM)</strong> to rank barriers. For each category, you will:</p>
        <ol style="line-height: 1.8;">
            <li>Select the <strong>most challenging barrier</strong> that plays the most critical role in hindering implementation</li>
            <li>Select the <strong>least challenging barrier</strong> that plays the least critical role</li>
            <li>Compare how much more challenging the most challenging barrier is compared to each of the other barriers</li>
            <li>Compare how much more challenging the other barriers are compared to the least challenging barrier</li>
        </ol>

        <p>For all comparisons, you will use the following scale:</p>
        <ul style="line-height: 1.8;">
            <li><strong>Slightly more challenging</strong> (minor difference in impact)</li>
            <li><strong>Moderately more challenging</strong> (noticeable difference in impact)</li>
            <li><strong>Significantly more challenging</strong> (substantial difference in impact)</li>
            <li><strong>Extremely more challenging</strong> (very large difference in impact)</li>
        </ul>
        
        <div class="intro-time">
            <span style="font-size: 1.5rem;">‚è±Ô∏è</span>
            <span><strong>Estimated time:</strong> 20-30 minutes</span>
        </div>
        

        <!-- Barriers Framework Image -->
        <div style="text-align: center; margin: 25px 0;">
            <img src="Barriers_RF.png" alt="Barriers Framework" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
            <p style="font-size: 0.9em; color: #666; margin-top: 8px;"><em>Figure 1: Barrier categories and sub-barriers</em></p>
        </div>

        <p><strong>Confidentiality:</strong> This survey is anonymous and responses will be used solely for academic research purposes. No personally identifiable information will be published.</p>
        
        <p style="font-size: 0.95em; color: #555;">This research is conducted by the Chair of Transportation Systems Engineering at Technical University of Munich (TUM), Germany. For questions, please contact: Shahriar Iqbal Zame (PhD candidate at TUM) at  <strong>shahriar.zame@tum.de</strong>  or Dr.-Ing. Mohammad Sadrani (Assistant Professor, University of Twente) at <strong>m.sadrani@utwente.nl</strong>. You may also reach out to our team leader Prof. Dr. Constantinos Antoniou at <strong>c.antoniou(at)tum.de.</strong>  </p>

            <button class="btn btn-start" onclick="tourSuppressed = false; navigateToPage(1);">Begin Survey ‚Üí</button>
        </div>
    </div>

    <!-- SECTION 2: Demographics -->
    <div class="page-content" id="page-1">
    <div class="demo-section" id="demo-section">
        <div class="section-header">
            <h2 style="margin:0; color:white;">About You</h2>
        </div>
        <p style="color: #7f8c8d; margin-top: 15px;">Please provide some information about your background. Fields marked with <span style="color:#e74c3c;">*</span> are required.</p>

        <div class="question-block" id="demo-block">
            <div class="form-row">
                <div class="form-group" id="fg-occupation">
                    <label>Job Title / Occupation <span class="required">*</span></label>
                    <input type="text" id="demo-occupation" placeholder="e.g., Professor, Manager, Researcher" required>
                </div>
                <div class="form-group" id="fg-industry">
                    <label>Industry Sector <span class="required">*</span></label>
                    <select id="demo-industry" required onchange="toggleIndustryOther()">
                        <option value="">-- Select --</option>
                        <option value="Freight/Logistics">Freight / Logistics</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Automotive/OEM">Automotive / OEM</option>
                        <option value="Energy/Utilities">Energy / Utilities</option>
                        <option value="Government/Public Sector">Government / Public Sector</option>
                        <option value="Academia/Research">Academia / Research</option>
                        <option value="Consulting">Consulting</option>
                        <option value="Technology">Technology</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group" id="fg-industry-other" style="display:none;">
                <label>Please specify Industry Sector <span class="required">*</span></label>
                <input type="text" id="demo-industry-other" placeholder="Enter your industry sector">
            </div>

            <div class="form-row">
                <div class="form-group" id="fg-experience">
                    <label>Years of Experience <span class="required">*</span></label>
                    <select id="demo-experience" required>
                        <option value="">-- Select --</option>
                        <option value="0-2">0 - 2 years</option>
                        <option value="3-5">3 - 5 years</option>
                        <option value="6-10">6 - 10 years</option>
                        <option value="11-15">11 - 15 years</option>
                        <option value="16-20">16 - 20 years</option>
                        <option value="20+">More than 20 years</option>
                    </select>
                </div>
                <div class="form-group" id="fg-education">
                    <label>Highest Education Level <span class="required">*</span></label>
                    <select id="demo-education" required onchange="toggleEducationOther()">
                        <option value="">-- Select --</option>
                        <option value="High School">High School</option>
                        <option value="Bachelor's">Bachelor's Degree</option>
                        <option value="Master's">Master's Degree</option>
                        <option value="PhD">PhD / Doctorate</option>
                        <option value="Professional">Professional Degree (MBA, JD, etc.)</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group" id="fg-education-other" style="display:none;">
                <label>Please specify Education Level <span class="required">*</span></label>
                <input type="text" id="demo-education-other" placeholder="Enter your education level">
            </div>

            <div class="form-group" id="fg-country">
                <label>Country <span class="required">*</span></label>
                <input type="text" id="demo-country" placeholder="Country of residence" required>
            </div>

            <div class="form-group" id="fg-expertise">
                <label>Area of Expertise (Optional)</label>
                <textarea id="demo-expertise" rows="2" placeholder="e.g., Fleet management, EV technology, Supply chain optimization..."></textarea>
                <small>Briefly describe your relevant expertise or specialization</small>
            </div>

            <div class="error-msg" id="demo-error" style="display:none;">Please fill in all required fields.</div>

            <div class="page-actions">
                <button class="btn btn-prev" onclick="navigateToPage(currentPage - 1)">‚Üê Previous</button>
                <button class="btn btn-next" onclick="navigateToPage(currentPage + 1)">Next ‚Üí</button>
                <button class="btn" onclick="exportData()" style="background:#7f8c8d;">üì• Export Data</button>
                <button class="btn btn-submit" id="submit-btn-demo" onclick="attemptSubmit()">Submit Survey</button>
                <button class="btn btn-reset" onclick="resetSurvey()">üóëÔ∏è Start Over</button>
            </div>
        </div>
    </div>
    </div>

    <!-- SECTION 3: Survey Questions -->
    <div id="survey-container"></div>

    <!-- Results -->
    <div id="results">
        <h2>‚úÖ Survey Complete!</h2>
        <p>Your responses have been successfully submitted. Thank you for participating in this research!</p>
        <p style="color: #7f8c8d;">You may now close this window.</p>
        <div id="summary"></div>
        <div class="submit-error" id="submit-error">
            <strong>Submission Error:</strong> <span id="error-message"></span>
            <p style="margin-top:10px; margin-bottom:0;">Your responses have been saved locally. Please try again or contact the researcher.</p>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h4 id="modal-title">Barrier Title</h4>
            <p id="modal-description">Description goes here...</p>
            <button class="modal-close" onclick="closeModal()">Close</button>
        </div>
    </div>

    <!-- Guided Tour Overlay -->
    <div id="tour-container" style="display:none;">
        <div class="tour-spotlight" id="tour-spotlight"></div>
        <div class="tour-tooltip" id="tour-tooltip">
            <div class="tour-tooltip-step" id="tour-step-label"></div>
            <div class="tour-tooltip-text" id="tour-text"></div>
            <div class="tour-tooltip-actions">
                <div class="tour-dots" id="tour-dots"></div>
                <div>
                    <button class="tour-tooltip-skip" id="tour-skip-btn" onclick="endTour()">Skip</button>
                    <button class="tour-tooltip-btn" id="tour-next-btn" onclick="advanceTour()">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/plain" id="legacy-survey-script">
        // =====================================================
        // CONFIGURATION - UPDATE THIS URL AFTER DEPLOYING YOUR GOOGLE APPS SCRIPT
        // =====================================================
        const GOOGLE_SCRIPT_URL = "";
        // =====================================================
        
        let respondentInfo = {};
        let demographicsLocked = false;
        
        const descriptions = {
            'High total cost of fleet ownership': 'High total cost of ownership results from expensive batteries, automation technologies, cost uncertainties, charging inefficiencies, limited servicing infrastructure, battery degradation, high electricity tariff during peak hour and increased system complexity, elevating operating expenses and diminishing overall economic viability.',
            'High infrastructure cost': 'Extensive capital is required for charging stations, grid upgrades, and electric road systems, creating major cost burdens especially for long-haul routes and small operators.',
            'High financial risk': 'Volatile freight demand undermines investment recovery for electric and automated trucks, which depend on high utilization. Low use of costly charging infrastructure increases financial risk, while broader economic uncertainty deters capital-constrained carriers and slows scalable deployment.',
            'Complex business models': 'Complex and unstandardized business models create financial uncertainty in electrified and automated freight. Ambiguous cost‚Äìbenefit allocation in collaborative schemes (e.g., platooning) and limited research on leasing or sharing models hinder capital mitigation.',
            'Battery lifecycle issues': 'Battery reliance on scarce minerals (lithium, cobalt, nickel) drives supply risks and extraction impacts. Energy-intensive manufacturing raises initial GHG emissions and material demand. Weak recycling and disposal systems heighten pollution and resource losses.',
            'Emissions from electricity generation': 'Environmental gains from electric freight depend on the grid\'s carbon intensity, shifting emissions from tailpipes to power generation. BEV benefits materialize only with low-carbon or renewable electricity. Carbon-intensive grids can negate reductions and increase SO‚ÇÇ and PM‚ÇÇ.‚ÇÖ from power plants.',
            'Ecological impact of charging infrastructure': 'ERS infrastructure adds significant material and ecological burdens. High metal use (e.g., copper) drives extraction toxicity. Large installations increase land-use. Studies often omit these impacts. Protective zones, permissions, noise protection zones are additional considerations.',
            'Emissions from induced demand with automation': 'Automation may increase overall freight demand and vehicle miles traveled, potentially offsetting environmental benefits from electrification.',
            'Limited battery range': 'Limited battery range in electric freight necessitates large, costly, and heavy battery packs, raising purchase costs, increasing TCO, inducing range anxiety, and reducing payload capacity, which can require larger fleets.',
            'Limited charging-network coverage': 'Sparse, uneven, and low-capacity charging networks hinder electric freight, limiting long-haul viability, and reducing operational flexibility. Insufficient public charging for on-route needs discourages adoption, reinforcing a "chicken-and-egg" cycle that delays infrastructure investment.',
            'Delay in power-grid upgrade': 'Insufficient power-grid upgrades hinder large-scale electric freight, as fleet charging creates major peak loads requiring costly and slow infrastructure expansion. High upgrade costs and risks of overload discourage adoption, delaying reliable high-power charging deployment.',
            'Uncertainty in technology maturity': 'Uncertain availability of electric and autonomous truck technologies delays investment decisions. Competing pathways (BEVs, fuel cells, ERS) and unclear deployment timelines for driverless systems increase risk. Limited data on CAV performance reinforces hesitation, leading operators to avoid long-term commitments to immature technologies.',
            'Charging time issues': 'Slow charging times reduce vehicle availability and disrupt delivery schedules, with congestion at peak hours further delaying operations, especially for heavy-duty trucks.',
            'Scheduling/synchronisation complexity': 'Rigid delivery schedules conflict with cost-efficient off-peak charging. Solving joint routing‚Äìcharging problems is computationally complex, and autonomous systems add further coordination challenges, especially for platoon synchronization.',
            'Uncertainty in traffic and weather conditions': 'ADS struggle in complex traffic and adverse weather, undermining reliability and trust, while low temperatures reduce EV range and unpredictable congestion disrupts scheduling.',
            'Lack of stakeholder collaboration': 'Misaligned priorities and unclear roles among OEMs, logistics operators, utilities, and governments hinder coordinated investment in charging, grid upgrades, and digital infrastructure.',
            'Lack of public acceptance': 'Low public acceptance delays electrified and automated freight, driven by safety concerns, distrust of autonomous systems, and fear of cyber risks. Limited awareness of benefits and resistance among drivers further hinder adoption, while weak trust slows supportive policy and investment.',
            'Job losses & workforce-transition concerns': 'Automation raises fears of job losses and downgraded work quality, especially for long-distance drivers, reducing acceptance. The shift toward technical roles demands new skills, but limited reskilling programs and an aging workforce intensify resistance and slow adoption.',
            'Inability to maintain required service levels': 'Unproven reliability of electric and autonomous systems threatens service levels required in freight, which operates within rigid time-windows and narrow margins.',
            'Safety risks': 'Safety concerns for electric freight focus on battery fire and explosion risks, while autonomous systems face distrust over unexpected failures and high cybersecurity vulnerability.',
            'Lack of supportive policies': 'Weak policy support and limited public financial incentives hinders electrified and automated freight by deterring investment in costly vehicles, charging, and grid upgrades.',
            'Lack of regulations and standardizations': 'Fragmented legal frameworks and standards for interoperability create investment uncertainty for electrified and automated freight. Ambiguous rules and unclear liability force costly human supervision, limiting autonomous benefits. Cross-border regulatory inconsistency adds complexity.',
            'Data governance challenges': 'Weak data governance and privacy concerns hinder collaboration and scalable connected operations, slowing market deployment.',
            'Difference in political prioritization': 'Divergent political priorities across different territories slow electrified and automated freight.'
        };

        const surveyData = {
            mainCategories: {
                title: "Main Category Barriers",
                items: ['Economic', 'Environmental', 'Technological', 'Operational', 'Social', 'Policy'],
                hasDescriptions: false
            },
            economic: {
                title: "Economic Barriers",
                items: ['High total cost of fleet ownership', 'High infrastructure cost', 'High financial risk', 'Complex business models'],
                hasDescriptions: true
            },
            environmental: {
                title: "Environmental Barriers",
                items: ['Battery lifecycle issues', 'Emissions from electricity generation', 'Ecological impact of charging infrastructure', 'Emissions from induced demand with automation'],
                hasDescriptions: true
            },
            technological: {
                title: "Technological Barriers",
                items: ['Limited battery range', 'Limited charging-network coverage', 'Delay in power-grid upgrade', 'Uncertainty in technology maturity'],
                hasDescriptions: true
            },
            operational: {
                title: "Operational Barriers",
                items: ['Charging time issues', 'Scheduling/synchronisation complexity', 'Uncertainty in traffic and weather conditions', 'Lack of stakeholder collaboration'],
                hasDescriptions: true
            },
            social: {
                title: "Social Barriers",
                items: ['Lack of public acceptance', 'Job losses & workforce-transition concerns', 'Inability to maintain required service levels', 'Safety risks'],
                hasDescriptions: true
            },
            policy: {
                title: "Policy Barriers",
                items: ['Lack of supportive policies', 'Lack of regulations and standardizations', 'Data governance challenges', 'Difference in political prioritization'],
                hasDescriptions: true
            }
        };

        const scaleOptions = ['Slightly more', 'Moderately more', 'Significantly more', 'Extremely more'];
        const sectionKeys = Object.keys(surveyData);
        let currentSection = -2;
        let responses = {};
        let lockedSections = {};

        // Multi-page navigation state
        let tourSuppressed = false;
        let currentPage = 0;
        let pageCompletionStatus = {
            0: true,  // Intro (no inputs, always complete)
            1: false, // Demographics
            2: false, // Main Categories
            3: false, // Economic
            4: false, // Environmental
            5: false, // Technological
            6: false, // Operational
            7: false, // Social
            8: false  // Policy
        };

        // Page Navigation Functions
        function navigateToPage(pageIndex) {
            // Hide current page
            const currentPageEl = document.getElementById(`page-${currentPage}`);
            if (currentPageEl) {
                currentPageEl.classList.remove('active');
                currentPageEl.style.display = 'none';
            }

            // Show target page
            const targetPageEl = document.getElementById(`page-${pageIndex}`);
            if (targetPageEl) {
                targetPageEl.classList.add('active');
                targetPageEl.style.display = 'block';
            }

            // Update current page
            currentPage = pageIndex;

            // Update progress bar
            updateProgressBar();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Auto-save progress
            if (typeof saveProgress === 'function') {
                saveProgress();
            }

            // Trigger guided tours
            if (!tourActive && !tourSuppressed) {
                if (pageIndex === 1 && shouldShowTour('survey_tour_1')) {
                    setTimeout(() => startTour(tour1Steps, 'survey_tour_1'), 600);
                } else if (pageIndex === 2 && shouldShowTour('survey_tour_2')) {
                    setTimeout(() => startTour(tour2Steps, 'survey_tour_2'), 800);
                } else if (pageIndex === 3 && shouldShowTour('survey_tour_3')) {
                    setTimeout(() => startTour(tour3Steps, 'survey_tour_3'), 800);
                }
            }
        }

        function checkPageCompletion(pageIndex) {
            if (pageIndex === 0) {
                // Intro page is always complete
                return true;
            } else if (pageIndex === 1) {
                // Demographics page
                const occupation = document.getElementById('demo-occupation')?.value.trim();
                let industry = document.getElementById('demo-industry')?.value;
                const experience = document.getElementById('demo-experience')?.value;
                let education = document.getElementById('demo-education')?.value;
                const country = document.getElementById('demo-country')?.value.trim();

                if (industry === 'Other') {
                    industry = document.getElementById('demo-industry-other')?.value.trim();
                }
                if (education === 'Other') {
                    education = document.getElementById('demo-education-other')?.value.trim();
                }

                return !!(occupation && industry && experience && education && country);
            } else {
                // Survey section pages (2-8)
                const sectionIndex = pageIndex - 2;
                const key = sectionKeys[sectionIndex];
                if (!key) return false;

                const sectionResponses = responses[key];
                if (!sectionResponses || !sectionResponses.most || !sectionResponses.least) {
                    return false;
                }

                // Check if comparison questions are visible and have content
                const comparisonContainer = document.getElementById(`${key}-comparisons`);
                const hasComparisonContent = comparisonContainer &&
                                            comparisonContainer.children.length > 0 &&
                                            comparisonContainer.style.display !== 'none';

                // If comparisons are visible, they must ALL be answered
                if (hasComparisonContent) {
                    const othersForMost = sectionResponses.othersForMost || [];
                    const othersForLeast = sectionResponses.othersForLeast || [];

                    // Check all MOST comparisons
                    for (let i = 0; i < othersForMost.length; i++) {
                        if (!sectionResponses[`comp_most_${i}`]) {
                            return false;
                        }
                    }

                    // Check all LEAST comparisons
                    for (let i = 0; i < othersForLeast.length; i++) {
                        if (!sectionResponses[`comp_least_${i}`]) {
                            return false;
                        }
                    }

                    return true;
                } else {
                    // Comparisons not visible yet, so page is incomplete
                    // (user must click "Continue to Comparison Questions" first)
                    return false;
                }
            }
        }

        function updateProgressBar() {
            // Update page completion status
            for (let i = 0; i <= 8; i++) {
                pageCompletionStatus[i] = checkPageCompletion(i);
            }

            // Update page indicators
            document.querySelectorAll('.page-indicator').forEach((indicator, index) => {
                // Remove all dynamic classes
                indicator.classList.remove('current-page', 'completed-page', 'incomplete-page');

                // Add current page border
                if (index === currentPage) {
                    indicator.classList.add('current-page');
                }

                // Add completed checkmark
                if (pageCompletionStatus[index]) {
                    indicator.classList.add('completed-page');
                }
            });

            // Update submit button state (check if all required pages are complete)
            const allComplete = pageCompletionStatus[1] && // Demographics
                                pageCompletionStatus[2] && // Main Categories
                                pageCompletionStatus[3] && // Economic
                                pageCompletionStatus[4] && // Environmental
                                pageCompletionStatus[5] && // Technological
                                pageCompletionStatus[6] && // Operational
                                pageCompletionStatus[7] && // Social
                                pageCompletionStatus[8];   // Policy

            // Update submit button style based on completion
            document.querySelectorAll('[id^="submit-btn"]').forEach(btn => {
                btn.style.opacity = allComplete ? '1' : '0.6';
            });
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            // Remove existing toast if any
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);

            // Hide and remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Save/Load/Export Functions
        function saveProgress() {
            try {
                console.log('=== SAVE PROGRESS CALLED ===');
                console.log('Current Page:', currentPage);
                console.log('Responses object:', JSON.parse(JSON.stringify(responses)));

                // Capture current demographics data before saving
                const occupation = document.getElementById('demo-occupation')?.value.trim();
                let industry = document.getElementById('demo-industry')?.value;
                const experience = document.getElementById('demo-experience')?.value;
                let education = document.getElementById('demo-education')?.value;
                const country = document.getElementById('demo-country')?.value.trim();
                const expertise = document.getElementById('demo-expertise')?.value.trim();

                // Handle "Other" selections
                if (industry === 'Other') {
                    industry = document.getElementById('demo-industry-other')?.value.trim();
                }
                if (education === 'Other') {
                    education = document.getElementById('demo-education-other')?.value.trim();
                }

                // Update respondentInfo with current values
                if (occupation || industry || experience || education || country) {
                    respondentInfo = {
                        occupation: occupation || respondentInfo.occupation,
                        industry: industry || respondentInfo.industry,
                        experience: experience || respondentInfo.experience,
                        education: education || respondentInfo.education,
                        country: country || respondentInfo.country,
                        expertise: expertise || respondentInfo.expertise,
                        startTime: respondentInfo.startTime || new Date().toISOString()
                    };
                }

                const payload = {
                    respondentInfo: respondentInfo,
                    responses: responses,
                    currentPage: currentPage,
                    timestamp: new Date().toISOString()
                };

                console.log('Payload to save:', JSON.parse(JSON.stringify(payload)));
                localStorage.setItem('survey_progress', JSON.stringify(payload));
                console.log('Saved to localStorage successfully');
                // Progress saved silently
                return true;
            } catch (error) {
                console.error('Save error:', error);
                showToast('Failed to save progress', 'error');
                return false;
            }
        }

        function resetSurvey() {
            if (!confirm('Are you sure you want to delete all progress and start over? This cannot be undone.')) {
                return;
            }
            localStorage.removeItem('survey_progress');
            localStorage.removeItem('survey_tour_1');
            localStorage.removeItem('survey_tour_2');
            localStorage.removeItem('survey_tour_3');
            location.reload();
        }

        function loadProgress() {
            try {
                console.log('=== LOAD PROGRESS CALLED ===');
                const savedData = localStorage.getItem('survey_progress');
                if (!savedData) {
                    console.log('No saved data found in localStorage');
                    return false;
                }

                const payload = JSON.parse(savedData);
                console.log('Loaded payload:', payload);

                // Restore data
                respondentInfo = payload.respondentInfo || {};
                responses = payload.responses || {};
                const savedPage = payload.currentPage || 0;

                console.log('Restored responses object:', responses);
                console.log('Section keys to restore:', sectionKeys);

                // Restore form fields - Demographics
                if (respondentInfo.occupation) document.getElementById('demo-occupation').value = respondentInfo.occupation;
                if (respondentInfo.industry) {
                    const industrySelect = document.getElementById('demo-industry');
                    // Check if it's a custom "Other" value
                    const isCustomIndustry = !Array.from(industrySelect.options).some(opt => opt.value === respondentInfo.industry);
                    if (isCustomIndustry) {
                        industrySelect.value = 'Other';
                        toggleIndustryOther();
                        document.getElementById('demo-industry-other').value = respondentInfo.industry;
                    } else {
                        industrySelect.value = respondentInfo.industry;
                    }
                }
                if (respondentInfo.experience) document.getElementById('demo-experience').value = respondentInfo.experience;
                if (respondentInfo.education) {
                    const educationSelect = document.getElementById('demo-education');
                    const isCustomEducation = !Array.from(educationSelect.options).some(opt => opt.value === respondentInfo.education);
                    if (isCustomEducation) {
                        educationSelect.value = 'Other';
                        toggleEducationOther();
                        document.getElementById('demo-education-other').value = respondentInfo.education;
                    } else {
                        educationSelect.value = respondentInfo.education;
                    }
                }
                if (respondentInfo.country) document.getElementById('demo-country').value = respondentInfo.country;
                if (respondentInfo.expertise) document.getElementById('demo-expertise').value = respondentInfo.expertise;

                // Restore survey responses
                sectionKeys.forEach(key => {
                    console.log(`--- Checking section: ${key} ---`);
                    console.log('Has responses?', !!responses[key]);
                    if (responses[key]) {
                        console.log('Responses for', key, ':', responses[key]);

                        // Restore most/least selections
                        if (responses[key].most) {
                            const mostRadio = document.querySelector(`input[name="${key}-most"][value="${responses[key].most}"]`);
                            if (mostRadio) {
                                mostRadio.checked = true;
                            }
                        }
                        if (responses[key].least) {
                            const leastRadio = document.querySelector(`input[name="${key}-least"][value="${responses[key].least}"]`);
                            if (leastRadio) {
                                leastRadio.checked = true;
                            }
                        }

                        // Trigger handleSelection to enable "Continue" button and update state
                        if (responses[key].most || responses[key].least) {
                            handleSelection(key);
                        }

                        // Check if this section has comparison responses
                        const hasComparisonData = Object.keys(responses[key]).some(k => k.startsWith('comp_'));
                        console.log('Has comparison data?', hasComparisonData);
                        console.log('Has most?', !!responses[key].most);
                        console.log('Has least?', !!responses[key].least);

                        if (hasComparisonData && responses[key].most && responses[key].least) {
                            console.log('=== RESTORING COMPARISONS FOR:', key, '===');
                            console.log('Comparison data:', responses[key]);

                            // Generate comparison questions by calling showComparisons
                            showComparisons(key);

                            // Wait a bit for DOM to update, then restore comparison selections
                            setTimeout(() => {
                                console.log('Attempting to restore comparison radio selections...');
                                let restoredCount = 0;
                                Object.keys(responses[key]).forEach(responseKey => {
                                    if (responseKey.startsWith('comp_')) {
                                        const radioName = `${key}-${responseKey.replace(/_/g, '-')}`;
                                        const value = responses[key][responseKey];
                                        console.log(`Looking for radio: name="${radioName}", value="${value}"`);
                                        const radio = document.querySelector(`input[name="${radioName}"][value="${value}"]`);
                                        if (radio) {
                                            radio.checked = true;
                                            restoredCount++;
                                            console.log(`‚úì Restored ${radioName} = ${value}`);
                                        } else {
                                            console.log(`‚úó Could not find radio: name="${radioName}", value="${value}"`);
                                        }
                                    }
                                });
                                console.log(`Total comparison questions restored: ${restoredCount}`);

                                // Restore unlock button visibility if comparisons exist
                                const comparisonContainer = document.getElementById(`${key}-comparisons`);
                                const hasComparisonContent = comparisonContainer && comparisonContainer.children.length > 0;

                                if (hasComparisonContent) {
                                    const continueBtn = document.getElementById(`${key}-continue`);
                                    const unlockBtn = document.getElementById(`${key}-unlock`);

                                    if (continueBtn) continueBtn.style.display = 'none';
                                    if (unlockBtn) unlockBtn.style.display = 'inline-block';
                                }

                                // Update progress bar after restoring comparisons
                                updateProgressBar();
                            }, 100);
                        }
                    }
                });

                // Navigate to saved page (suppress tour on restore)
                tourSuppressed = true;
                setTimeout(() => {
                    navigateToPage(savedPage);
                    updateProgressBar();
                    showToast('Previous progress restored!', 'info');
                }, 200);

                return true;
            } catch (error) {
                console.error('Load error:', error);
                showToast('Failed to load saved progress', 'error');
                return false;
            }
        }

        function exportData() {
            try {
                const payload = {
                    respondentInfo: respondentInfo,
                    responses: responses,
                    currentPage: currentPage,
                    exported: new Date().toISOString()
                };

                const dataStr = JSON.stringify(payload, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `survey_backup_${Date.now()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast('Survey data exported successfully!', 'success');
                return true;
            } catch (error) {
                console.error('Export error:', error);
                showToast('Failed to export data', 'error');
                return false;
            }
        }

        function showDemographics() {
            document.getElementById('intro-page').style.display = 'none';
            document.getElementById('demo-section').style.display = 'block';
            currentSection = -1;
            updateProgress();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleIndustryOther() {
            const industrySelect = document.getElementById('demo-industry');
            const otherGroup = document.getElementById('fg-industry-other');
            if (industrySelect.value === 'Other') {
                otherGroup.style.display = 'block';
            } else {
                otherGroup.style.display = 'none';
                document.getElementById('demo-industry-other').value = '';
            }
        }

        function toggleEducationOther() {
            const educationSelect = document.getElementById('demo-education');
            const otherGroup = document.getElementById('fg-education-other');
            if (educationSelect.value === 'Other') {
                otherGroup.style.display = 'block';
            } else {
                otherGroup.style.display = 'none';
                document.getElementById('demo-education-other').value = '';
            }
        }

        function lockDemographics() {
            demographicsLocked = true;
            const formGroups = ['fg-occupation', 'fg-industry', 'fg-industry-other',
                               'fg-experience', 'fg-education', 'fg-education-other', 'fg-country', 'fg-expertise'];
            formGroups.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('locked');
            });
            document.getElementById('demo-continue').style.display = 'none';
        }

        function startSurvey() {
            const occupation = document.getElementById('demo-occupation').value.trim();
            let industry = document.getElementById('demo-industry').value;
            const experience = document.getElementById('demo-experience').value;
            let education = document.getElementById('demo-education').value;
            const country = document.getElementById('demo-country').value.trim();
            const expertise = document.getElementById('demo-expertise').value.trim();

            // Check if "Other" is selected for industry and validate the text input
            if (industry === 'Other') {
                const industryOther = document.getElementById('demo-industry-other').value.trim();
                if (!industryOther) {
                    document.getElementById('demo-error').style.display = 'block';
                    document.getElementById('demo-error').textContent = 'Please specify your industry sector.';
                    return;
                }
                industry = industryOther;
            }

            // Check if "Other" is selected for education and validate the text input
            if (education === 'Other') {
                const educationOther = document.getElementById('demo-education-other').value.trim();
                if (!educationOther) {
                    document.getElementById('demo-error').style.display = 'block';
                    document.getElementById('demo-error').textContent = 'Please specify your education level.';
                    return;
                }
                education = educationOther;
            }

            if (!occupation || !industry || !experience || !education || !country) {
                document.getElementById('demo-error').style.display = 'block';
                document.getElementById('demo-error').textContent = 'Please fill in all required fields.';
                return;
            }

            respondentInfo = {
                occupation, industry, experience, education, country, expertise,
                startTime: new Date().toISOString()
            };

            document.getElementById('demo-error').style.display = 'none';
            lockDemographics();
            document.getElementById('survey-container').style.display = 'block';

            currentSection = 0;
            updateProgress();
            initSurvey();

            // Scroll to survey
            document.getElementById('survey-container').scrollIntoView({ behavior: 'smooth' });
        }

        function showInfo(barrier) {
            document.getElementById('modal-title').textContent = barrier;
            document.getElementById('modal-description').textContent = descriptions[barrier] || 'No description available.';
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        document.getElementById('modal-overlay').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        function renderBarrierItem(item, hasDescription) {
            if (hasDescription && descriptions[item]) {
                return `<span class="barrier-name">${item}</span><button type="button" class="info-btn" onclick="showInfo('${item.replace(/'/g, "\\'")}')">i</button>`;
            }
            return `<span class="barrier-name">${item}</span>`;
        }

        function generateSection(key, sectionIndex) {
            const data = surveyData[key];
            const items = data.items;
            const hasDesc = data.hasDescriptions;
            const pageNumber = sectionIndex + 2; // Pages 2-8 (0=intro, 1=demo, 2-8=survey sections)

            let html = `
                <div class="page-content" id="page-${pageNumber}">
                    <div class="section" id="section-${key}">
                        <div class="section-header">
                            <h2 style="margin:0; color:white;">${data.title}</h2>
                        </div>

                        <div class="question-block" id="${key}-q1-block">
                            <div class="question-number">Question 1</div>
                            <div class="question-text">Which is the <span class="highlight-most">Most challenging</span> barrier among ${data.title}?</div>
                            <div class="options" id="${key}-q1-options">
                                ${items.map((item, idx) => `
                                    <label>
                                        <input type="radio" name="${key}-most" value="${item}" onchange="handleSelection('${key}')">
                                        ${renderBarrierItem(item, hasDesc)}
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <div class="question-block" id="${key}-q2-block">
                            <div class="question-number">Question 2</div>
                            <div class="question-text">Which is the <span class="highlight-least">Least challenging</span> barrier among ${data.title}?</div>
                            <div class="options" id="${key}-q2-options">
                                ${items.map((item, idx) => `
                                    <label>
                                        <input type="radio" name="${key}-least" value="${item}" onchange="handleSelection('${key}')">
                                        ${renderBarrierItem(item, hasDesc)}
                                    </label>
                                `).join('')}
                            </div>
                            <div class="error-msg" id="${key}-error" style="display:none;">Most and Least challenging cannot be the same!</div>
                        </div>

                        <button class="btn" id="${key}-continue" disabled onclick="showComparisons('${key}')">Continue to Comparison Questions ‚Üí</button>
                        <button class="btn btn-unlock" id="${key}-unlock" style="display:none;" onclick="unlockSelections('${key}')">üîì Unlock Questions 1 & 2</button>

                        <div class="comparison-section" id="${key}-comparisons"></div>

                        <div class="validation-error" id="${key}-validation-error">
                            Please answer all comparison questions before proceeding.
                        </div>

                        <div class="page-actions">
                            <button class="btn btn-prev" onclick="navigateToPage(currentPage - 1)">‚Üê Previous</button>
                            ${sectionIndex < sectionKeys.length - 1 ? '<button class="btn btn-next" onclick="navigateToPage(currentPage + 1)">Next ‚Üí</button>' : ''}
                            <button class="btn" onclick="exportData()" style="background:#7f8c8d;">üì• Export Data</button>
                            <button class="btn btn-submit" id="submit-btn-page-${pageNumber}" onclick="attemptSubmit()">Submit Survey</button>
                            <button class="btn btn-reset" onclick="resetSurvey()">üóëÔ∏è Start Over</button>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function handleSelection(key) {
            console.log('=== HANDLE SELECTION CALLED ===');
            console.log('Section Key:', key);

            // Check if selection is locked
            if (lockedSections[key + '-selection']) {
                console.log('Section is locked, returning');
                return;
            }

            const mostSelected = document.querySelector(`input[name="${key}-most"]:checked`);
            const leastSelected = document.querySelector(`input[name="${key}-least"]:checked`);

            const most = mostSelected ? mostSelected.value : null;
            const least = leastSelected ? leastSelected.value : null;

            console.log('Most:', most, 'Least:', least);

            const btn = document.getElementById(`${key}-continue`);
            const error = document.getElementById(`${key}-error`);

            if (most && least && most === least) {
                error.style.display = 'block';
                btn.disabled = true;
            } else {
                error.style.display = 'none';
                btn.disabled = !(most && least);
            }

            if (!responses[key]) responses[key] = {};
            responses[key].most = most;
            responses[key].least = least;

            console.log('Updated responses[' + key + ']:', responses[key]);

            // Update progress bar
            updateProgressBar();

            // Auto-save progress after selection
            console.log('Calling saveProgress...');
            if (typeof saveProgress === 'function') {
                saveProgress();
            }
        }

        function lockSelectionQuestions(key) {
            lockedSections[key + '-selection'] = true;
            
            // Lock Q1 and Q2 blocks
            const q1Block = document.getElementById(`${key}-q1-block`);
            const q2Block = document.getElementById(`${key}-q2-block`);
            
            if (q1Block) q1Block.classList.add('locked');
            if (q2Block) q2Block.classList.add('locked');
            
            // Disable all radio buttons
            document.querySelectorAll(`input[name="${key}-most"]`).forEach(r => r.disabled = true);
            document.querySelectorAll(`input[name="${key}-least"]`).forEach(r => r.disabled = true);
        }

        function unlockSelections(key) {
            console.log('=== UNLOCK SELECTIONS CALLED FOR:', key, '===');

            // Store current selections to detect changes
            const oldMost = responses[key]?.most;
            const oldLeast = responses[key]?.least;

            console.log('Previous selections - Most:', oldMost, 'Least:', oldLeast);

            // 1. Unlock the lock state
            lockedSections[key + '-selection'] = false;

            // 2. Remove locked CSS class from Q1 and Q2 blocks
            const q1Block = document.getElementById(`${key}-q1-block`);
            const q2Block = document.getElementById(`${key}-q2-block`);

            if (q1Block) q1Block.classList.remove('locked');
            if (q2Block) q2Block.classList.remove('locked');

            // 3. Re-enable all Most/Least radio buttons
            document.querySelectorAll(`input[name="${key}-most"]`).forEach(r => r.disabled = false);
            document.querySelectorAll(`input[name="${key}-least"]`).forEach(r => r.disabled = false);

            // 4. Hide comparison questions section
            const comparisonContainer = document.getElementById(`${key}-comparisons`);
            if (comparisonContainer) {
                comparisonContainer.style.display = 'none';
            }

            // 5. Show "Continue" button, hide "Unlock" button
            const continueBtn = document.getElementById(`${key}-continue`);
            const unlockBtn = document.getElementById(`${key}-unlock`);

            if (continueBtn) {
                continueBtn.style.display = 'inline-block';
                continueBtn.disabled = false; // Re-enable since selections already made
            }
            if (unlockBtn) unlockBtn.style.display = 'none';

            // 6. Store old selections for change detection
            responses[key]._unlockMode = true;
            responses[key]._oldMost = oldMost;
            responses[key]._oldLeast = oldLeast;

            // 7. Update progress bar (page now incomplete until comparisons redone)
            updateProgressBar();

            // 8. Scroll to Q1 for visibility
            window.scrollTo({
                top: q1Block.offsetTop - 100,
                behavior: 'smooth'
            });

            console.log('Unlocked successfully. User can now modify Q1 & 2.');
        }

        function lockComparisonQuestions(key) {
            lockedSections[key + '-comparisons'] = true;
            
            // Lock all comparison blocks
            const compSection = document.getElementById(`${key}-comparisons`);
            if (compSection) {
                compSection.querySelectorAll('.question-block').forEach(block => {
                    block.classList.add('locked');
                });
                compSection.querySelectorAll('input[type="radio"]').forEach(r => {
                    r.disabled = true;
                });
            }
        }

        function showComparisons(key) {
            // DETECT IF THIS IS A RE-ENTRY (after unlock)
            const isReentry = responses[key]?._unlockMode === true;

            if (isReentry) {
                console.log('=== RE-ENTRY DETECTED - Checking for changes ===');

                const oldMost = responses[key]._oldMost;
                const oldLeast = responses[key]._oldLeast;
                const newMost = responses[key].most;
                const newLeast = responses[key].least;

                const mostChanged = oldMost !== newMost;
                const leastChanged = oldLeast !== newLeast;

                console.log('Most changed:', mostChanged, '(', oldMost, '‚Üí', newMost, ')');
                console.log('Least changed:', leastChanged, '(', oldLeast, '‚Üí', newLeast, ')');

                // CLEAR AFFECTED COMPARISON ANSWERS
                if (mostChanged && leastChanged) {
                    // BOTH changed - clear ALL comparison answers
                    console.log('Both changed - clearing all comparison answers');
                    clearAllComparisonAnswers(key);
                } else if (mostChanged && !leastChanged) {
                    // Only MOST changed - clear comp_most_* answers
                    console.log('Only Most changed - clearing comp_most_* answers');
                    clearMostComparisonAnswers(key);
                } else if (leastChanged && !mostChanged) {
                    // Only LEAST changed - clear comp_least_* answers
                    console.log('Only Least changed - clearing comp_least_* answers');
                    clearLeastComparisonAnswers(key);
                } else {
                    // No changes - just re-show existing comparisons
                    console.log('No changes detected - restoring previous answers');
                }

                // Clean up temporary unlock flags
                delete responses[key]._unlockMode;
                delete responses[key]._oldMost;
                delete responses[key]._oldLeast;
            }

            // Lock the Most/Least selection
            lockSelectionQuestions(key);

            const data = surveyData[key];
            const hasDesc = data.hasDescriptions;
            const most = responses[key].most;
            const least = responses[key].least;
            
            // All other barriers (excluding MOST) for "MOST vs others" comparisons
            const othersForMost = data.items.filter(item => item !== most);

            // All other barriers (excluding BOTH MOST and LEAST) for "others vs LEAST" comparisons
            const othersForLeast = data.items.filter(item => item !== least && item !== most);
            
            // Store for data collection
            responses[key].othersForMost = othersForMost;
            responses[key].othersForLeast = othersForLeast;
            
            const container = document.getElementById(`${key}-comparisons`);
            let html = '<h3>Comparison Questions</h3>';
            html += '<div class="locked-notice">‚ö†Ô∏è Your Most/Least selections (questions 1 & 2) are now locked. Unlocking them will reset the comparison questions (from question 3 onwards) of this page only.</div>';
            let questionNum = 3;
            
            // SET 1: MOST challenging compared to ALL other barriers (including LEAST)
            html += `<div class="comparison-set-title">Comparing <span class="highlight-most">${most}</span> (Most Challenging) to all other barriers:</div>`;
            
            othersForMost.forEach((barrier, idx) => {
                const isLeast = barrier === least;
                const barrierLabel = isLeast
                    ? `<span class="highlight-least">${barrier}</span>${hasDesc && descriptions[barrier] ? `<button type="button" class="info-btn" onclick="showInfo('${barrier.replace(/'/g, "\\\\'")}')">i</button>` : ''} (Least Challenging)`
                    : renderBarrierItem(barrier, hasDesc);

                const mostLabel = `<span class="highlight-most">${most}</span>${hasDesc && descriptions[most] ? `<button type="button" class="info-btn" onclick="showInfo('${most.replace(/'/g, "\\\\'")}')">i</button>` : ''}`;

                html += `
                    <div class="question-block" id="${key}-comp-most-${idx}-block">
                        <div class="question-number">Question ${questionNum}</div>
                        <div class="question-text">
                            How much more challenging is ${mostLabel} (Most Challenging)
                            compared to ${barrierLabel}?
                        </div>
                        <div class="options">
                            ${scaleOptions.map(opt => `
                                <label>
                                    <input type="radio" name="${key}-comp-most-${idx}" value="${opt}" onchange="storeComparison('${key}', 'comp_most_${idx}', '${opt}')">
                                    <span>${opt}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                questionNum++;
            });
            
            // SET 2: ALL other barriers (including MOST) compared to LEAST
            html += `<div class="comparison-set-title">Comparing all other barriers to <span class="highlight-least">${least}</span> (Least Challenging):</div>`;
            
            othersForLeast.forEach((barrier, idx) => {
                const isMost = barrier === most;
                const barrierLabel = isMost
                    ? `<span class="highlight-most">${barrier}</span>${hasDesc && descriptions[barrier] ? `<button type="button" class="info-btn" onclick="showInfo('${barrier.replace(/'/g, "\\\\'")}')">i</button>` : ''} (Most Challenging)`
                    : renderBarrierItem(barrier, hasDesc);

                const leastLabel = `<span class="highlight-least">${least}</span>${hasDesc && descriptions[least] ? `<button type="button" class="info-btn" onclick="showInfo('${least.replace(/'/g, "\\\\'")}')">i</button>` : ''}`;

                html += `
                    <div class="question-block" id="${key}-comp-least-${idx}-block">
                        <div class="question-number">Question ${questionNum}</div>
                        <div class="question-text">
                            How much more challenging is ${barrierLabel}
                            compared to ${leastLabel} (Least Challenging)?
                        </div>
                        <div class="options">
                            ${scaleOptions.map(opt => `
                                <label>
                                    <input type="radio" name="${key}-comp-least-${idx}" value="${opt}" onchange="storeComparison('${key}', 'comp_least_${idx}', '${opt}')">
                                    <span>${opt}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                questionNum++;
            });
            
            container.innerHTML = html;
            container.style.display = 'block';

            // Show unlock button and hide continue button
            const continueBtn = document.getElementById(`${key}-continue`);
            const unlockBtn = document.getElementById(`${key}-unlock`);

            if (continueBtn) continueBtn.style.display = 'none';
            if (unlockBtn) unlockBtn.style.display = 'inline-block';

            container.scrollIntoView({ behavior: 'smooth' });
        }

        function clearAllComparisonAnswers(key) {
            console.log('Clearing ALL comparison answers for:', key);

            const keysToDelete = Object.keys(responses[key]).filter(k =>
                k.startsWith('comp_most_') || k.startsWith('comp_least_')
            );

            keysToDelete.forEach(k => {
                console.log('  Deleting:', k);
                delete responses[key][k];
            });

            // Clear metadata arrays
            delete responses[key].othersForMost;
            delete responses[key].othersForLeast;

            console.log('Total cleared:', keysToDelete.length, 'comparison answers');
        }

        function clearMostComparisonAnswers(key) {
            console.log('Clearing MOST comparison answers for:', key);

            const keysToDelete = Object.keys(responses[key]).filter(k =>
                k.startsWith('comp_most_')
            );

            keysToDelete.forEach(k => {
                console.log('  Deleting:', k);
                delete responses[key][k];
            });

            // Clear othersForMost array (will be regenerated)
            delete responses[key].othersForMost;

            console.log('Total cleared:', keysToDelete.length, 'MOST comparison answers');
        }

        function clearLeastComparisonAnswers(key) {
            console.log('Clearing LEAST comparison answers for:', key);

            const keysToDelete = Object.keys(responses[key]).filter(k =>
                k.startsWith('comp_least_')
            );

            keysToDelete.forEach(k => {
                console.log('  Deleting:', k);
                delete responses[key][k];
            });

            // Clear othersForLeast array (will be regenerated)
            delete responses[key].othersForLeast;

            console.log('Total cleared:', keysToDelete.length, 'LEAST comparison answers');
        }

        function storeComparison(key, compKey, value) {
            console.log('=== STORE COMPARISON CALLED ===');
            console.log('Section Key:', key, 'Comparison Key:', compKey, 'Value:', value);

            if (!responses[key]) responses[key] = {};
            responses[key][compKey] = value;

            console.log('Updated responses[' + key + ']:', responses[key]);

            // Clear highlighting when answered
            const blockId = `${key}-${compKey.replace('_', '-')}-block`;
            const block = document.getElementById(blockId);
            if (block) {
                block.classList.remove('unanswered');
            }

            // Update progress bar
            updateProgressBar();

            // Auto-save progress after comparison selection
            console.log('Calling saveProgress...');
            if (typeof saveProgress === 'function') {
                saveProgress();
            }
        }

        function validateAndNext(key) {
            const data = surveyData[key];
            const othersForMost = responses[key].othersForMost || [];
            const othersForLeast = responses[key].othersForLeast || [];
            
            let allAnswered = true;
            let firstUnanswered = null;
            
            // Check all "MOST vs others" questions
            othersForMost.forEach((barrier, idx) => {
                const answered = document.querySelector(`input[name="${key}-comp-most-${idx}"]:checked`);
                const block = document.getElementById(`${key}-comp-most-${idx}-block`);
                if (!answered) {
                    allAnswered = false;
                    if (block) {
                        block.classList.add('unanswered');
                        if (!firstUnanswered) firstUnanswered = block;
                    }
                } else if (block) {
                    block.classList.remove('unanswered');
                }
            });
            
            // Check all "others vs LEAST" questions
            othersForLeast.forEach((barrier, idx) => {
                const answered = document.querySelector(`input[name="${key}-comp-least-${idx}"]:checked`);
                const block = document.getElementById(`${key}-comp-least-${idx}-block`);
                if (!answered) {
                    allAnswered = false;
                    if (block) {
                        block.classList.add('unanswered');
                        if (!firstUnanswered) firstUnanswered = block;
                    }
                } else if (block) {
                    block.classList.remove('unanswered');
                }
            });
            
            if (!allAnswered) {
                document.getElementById(`${key}-validation-error`).style.display = 'block';
                if (firstUnanswered) {
                    firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            document.getElementById(`${key}-validation-error`).style.display = 'none';

            // Lock the comparison questions
            lockComparisonQuestions(key);

            // Add locked notice after comparisons
            const compSection = document.getElementById(`${key}-comparisons`);
            const existingNotice = compSection.querySelector('.locked-notice:last-child');
            if (!existingNotice || !existingNotice.textContent.includes('locked')) {
                compSection.insertAdjacentHTML('beforeend', '<div class="locked-notice" style="margin-top:15px;">‚úì This section is complete and locked.</div>');
            }
            
            nextSection();
        }

        function nextSection() {
            currentSection++;
            updateProgress();
            
            if (currentSection >= sectionKeys.length) {
                // Final validation before submit
                if (validateAllSections()) {
                    respondentInfo.endTime = new Date().toISOString();
                    submitSurvey();
                }
            } else {
                const key = sectionKeys[currentSection];
                document.getElementById(`section-${key}`).style.display = 'block';
                document.getElementById(`section-${key}`).scrollIntoView({ behavior: 'smooth' });
            }
        }

        function scrollToFirstIncomplete(pageIndex) {
            let target = null;

            if (pageIndex === 1) {
                // Demographics: find first empty required field
                const fields = [
                    { id: 'demo-occupation', wrapper: 'fg-occupation' },
                    { id: 'demo-industry', wrapper: 'fg-industry' },
                    { id: 'demo-experience', wrapper: 'fg-experience' },
                    { id: 'demo-education', wrapper: 'fg-education' },
                    { id: 'demo-country', wrapper: 'fg-country' }
                ];
                for (const f of fields) {
                    const el = document.getElementById(f.id);
                    if (!el) continue;
                    let val = el.value.trim();
                    // Handle "Other" sub-fields
                    if (val === 'Other') {
                        const otherId = f.id + '-other';
                        const otherEl = document.getElementById(otherId);
                        val = otherEl ? otherEl.value.trim() : '';
                        if (!val) { target = document.getElementById(f.wrapper + '-other') || otherEl; break; }
                    }
                    if (!val) { target = document.getElementById(f.wrapper); break; }
                }
            } else if (pageIndex >= 2) {
                // Survey section pages
                const sectionIndex = pageIndex - 2;
                const key = sectionKeys[sectionIndex];
                if (!key) return;

                const sectionResponses = responses[key] || {};

                // Check Q1 (most) and Q2 (least)
                if (!sectionResponses.most) {
                    target = document.getElementById(`${key}-q1-block`);
                } else if (!sectionResponses.least) {
                    target = document.getElementById(`${key}-q2-block`);
                } else {
                    // Check if comparisons are visible
                    const compContainer = document.getElementById(`${key}-comparisons`);
                    if (!compContainer || compContainer.children.length === 0 || compContainer.style.display === 'none') {
                        // Comparisons not started ‚Äî highlight the Continue button
                        target = document.getElementById(`${key}-continue`);
                    } else {
                        // Find first unanswered comparison question
                        const othersForMost = sectionResponses.othersForMost || [];
                        const othersForLeast = sectionResponses.othersForLeast || [];
                        for (let i = 0; i < othersForMost.length; i++) {
                            if (!sectionResponses[`comp_most_${i}`]) {
                                target = document.getElementById(`${key}-comp-most-${i}-block`);
                                break;
                            }
                        }
                        if (!target) {
                            for (let i = 0; i < othersForLeast.length; i++) {
                                if (!sectionResponses[`comp_least_${i}`]) {
                                    target = document.getElementById(`${key}-comp-least-${i}-block`);
                                    break;
                                }
                            }
                        }
                    }
                }
            }

            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Brief highlight effect
                target.style.outline = '3px solid #e74c3c';
                target.style.outlineOffset = '4px';
                setTimeout(() => {
                    target.style.outline = '';
                    target.style.outlineOffset = '';
                }, 2000);
            }
        }

        function validateAllPages() {
            // Update completion status for all pages
            for (let i = 0; i <= 8; i++) {
                pageCompletionStatus[i] = checkPageCompletion(i);
            }

            // Find incomplete pages
            const incompletePages = [];
            // Page 0 (intro) doesn't need validation
            for (let i = 1; i <= 8; i++) {
                if (!pageCompletionStatus[i]) {
                    incompletePages.push(i);
                }
            }

            if (incompletePages.length > 0) {
                // Remove previous incomplete markers
                document.querySelectorAll('.page-indicator').forEach(indicator => {
                    indicator.classList.remove('incomplete-page');
                });

                // Add red outline to incomplete pages
                incompletePages.forEach(pageIndex => {
                    const indicator = document.querySelector(`.page-indicator[data-page="${pageIndex}"]`);
                    if (indicator) {
                        indicator.classList.add('incomplete-page');
                    }
                });

                // Build error message
                const pageNames = {
                    1: 'Demographics',
                    2: 'Main Categories',
                    3: 'Economic Barriers',
                    4: 'Environmental Barriers',
                    5: 'Technological Barriers',
                    6: 'Operational Barriers',
                    7: 'Social Barriers',
                    8: 'Policy Barriers'
                };

                const incompletePageNames = incompletePages.map(i => pageNames[i]).join(', ');
                showToast(`Please complete: ${incompletePageNames}`, 'error');

                // Navigate to first incomplete page and scroll to first unfilled question
                const firstIncompletePage = incompletePages[0];
                navigateToPage(firstIncompletePage);
                setTimeout(() => scrollToFirstIncomplete(firstIncompletePage), 400);

                return false;
            }

            // Remove any incomplete markers
            document.querySelectorAll('.page-indicator').forEach(indicator => {
                indicator.classList.remove('incomplete-page');
            });

            return true;
        }

        function captureDemographics() {
            const occupation = document.getElementById('demo-occupation')?.value.trim();
            let industry = document.getElementById('demo-industry')?.value;
            const experience = document.getElementById('demo-experience')?.value;
            let education = document.getElementById('demo-education')?.value;
            const country = document.getElementById('demo-country')?.value.trim();
            const expertise = document.getElementById('demo-expertise')?.value.trim();

            // Handle "Other" selections
            if (industry === 'Other') {
                industry = document.getElementById('demo-industry-other')?.value.trim();
            }
            if (education === 'Other') {
                education = document.getElementById('demo-education-other')?.value.trim();
            }

            respondentInfo = {
                occupation,
                industry,
                experience,
                education,
                country,
                expertise,
                startTime: respondentInfo.startTime || new Date().toISOString()
            };
        }

        function attemptSubmit() {
            // Capture demographics data
            captureDemographics();

            // Validate and submit
            if (validateAllPages()) {
                respondentInfo.endTime = new Date().toISOString();
                submitSurvey();
            }
        }

        async function submitSurvey() {
            document.getElementById('submit-overlay').classList.add('active');
            
            const payload = {
                respondent: respondentInfo,
                responses: responses
            };
            
            console.log('Submitting payload:', payload);
            
            try {
                if (GOOGLE_SCRIPT_URL === "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE") {
                    throw new Error("Google Apps Script URL not configured. Please update GOOGLE_SCRIPT_URL in the HTML file.");
                }
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                document.getElementById('submit-overlay').classList.remove('active');
                document.getElementById('results').style.display = 'block';
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                generateSummary();
                
            } catch (error) {
                console.error('Submission error:', error);
                document.getElementById('submit-overlay').classList.remove('active');
                document.getElementById('results').style.display = 'block';
                document.getElementById('submit-error').style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                generateSummary();
                
                localStorage.setItem('survey_backup_' + Date.now(), JSON.stringify(payload));
            }
        }

        function updateProgress() {
            const totalSteps = sectionKeys.length + 2;
            const currentStep = currentSection + 3;
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progress').style.width = `${Math.min(progress, 100)}%`;
            
            if (currentSection === -2) {
                document.getElementById('progress-text').textContent = 'Introduction';
            } else if (currentSection === -1) {
                document.getElementById('progress-text').textContent = 'About You';
            } else if (currentSection < sectionKeys.length) {
                const sectionNames = ['Main Categories', 'Economic', 'Environmental', 'Technological', 'Operational', 'Social', 'Policy'];
                document.getElementById('progress-text').textContent = `Section ${currentSection + 1} of ${sectionKeys.length}: ${sectionNames[currentSection]}`;
            } else {
                document.getElementById('progress-text').textContent = 'Complete!';
            }
        }

        function generateSummary() {
            let html = '<h3>Your Responses Summary</h3>';

            // Demographics
            html += '<div style="margin-bottom:18px;">';
            html += `<p style="margin:4px 0;"><strong>Job Title:</strong> ${respondentInfo.occupation || 'N/A'}</p>`;
            html += `<p style="margin:4px 0;"><strong>Industry:</strong> ${respondentInfo.industry || 'N/A'}</p>`;
            html += `<p style="margin:4px 0;"><strong>Experience:</strong> ${respondentInfo.experience || 'N/A'}</p>`;
            html += `<p style="margin:4px 0;"><strong>Education:</strong> ${respondentInfo.education || 'N/A'}</p>`;
            html += `<p style="margin:4px 0;"><strong>Country:</strong> ${respondentInfo.country || 'N/A'}</p>`;
            html += `<p style="margin:4px 0;"><strong>Expertise Level:</strong> ${respondentInfo.expertise || 'N/A'}</p>`;
            html += '</div>';

            // Each section
            sectionKeys.forEach(key => {
                const resp = responses[key];
                if (!resp) return;
                const data = surveyData[key];

                html += '<div style="margin-bottom:18px; padding:12px; background:#eafaf1; border-radius:6px;">';
                html += `<h4 style="margin:0 0 8px 0;">${data.title}</h4>`;
                html += `<p style="margin:4px 0;"><strong>Most Challenging:</strong> ${resp.most || 'N/A'}</p>`;
                html += `<p style="margin:4px 0;"><strong>Least Challenging:</strong> ${resp.least || 'N/A'}</p>`;

                // Comparison: Most vs others
                const othersForMost = resp.othersForMost || [];
                if (othersForMost.length > 0) {
                    html += `<p style="margin:10px 0 4px 0;"><strong>Comparisons ‚Äî ${resp.most} (Most) vs others:</strong></p>`;
                    html += '<table style="border-collapse:collapse; width:100%; margin-bottom:8px; font-size:0.9rem;">';
                    html += '<tr style="background:#d5f5e3;"><th style="text-align:left; padding:4px 8px; border:1px solid #b2dfdb;">Compared to</th><th style="text-align:left; padding:4px 8px; border:1px solid #b2dfdb;">Rating</th></tr>';
                    othersForMost.forEach((barrier, idx) => {
                        const answer = resp[`comp_most_${idx}`] || 'N/A';
                        const label = barrier === resp.least ? `${barrier} (Least)` : barrier;
                        html += `<tr><td style="padding:4px 8px; border:1px solid #b2dfdb;">${label}</td><td style="padding:4px 8px; border:1px solid #b2dfdb;">${answer}</td></tr>`;
                    });
                    html += '</table>';
                }

                // Comparison: Others vs Least
                const othersForLeast = resp.othersForLeast || [];
                if (othersForLeast.length > 0) {
                    html += `<p style="margin:10px 0 4px 0;"><strong>Comparisons ‚Äî others vs ${resp.least} (Least):</strong></p>`;
                    html += '<table style="border-collapse:collapse; width:100%; font-size:0.9rem;">';
                    html += '<tr style="background:#d5f5e3;"><th style="text-align:left; padding:4px 8px; border:1px solid #b2dfdb;">Barrier</th><th style="text-align:left; padding:4px 8px; border:1px solid #b2dfdb;">Rating</th></tr>';
                    othersForLeast.forEach((barrier, idx) => {
                        const answer = resp[`comp_least_${idx}`] || 'N/A';
                        const label = barrier === resp.most ? `${barrier} (Most)` : barrier;
                        html += `<tr><td style="padding:4px 8px; border:1px solid #b2dfdb;">${label}</td><td style="padding:4px 8px; border:1px solid #b2dfdb;">${answer}</td></tr>`;
                    });
                    html += '</table>';
                }

                html += '</div>';
            });

            document.getElementById('summary').innerHTML = html;
        }

        function initSurvey() {
            const container = document.getElementById('survey-container');

            sectionKeys.forEach((key, idx) => {
                container.innerHTML += generateSection(key, idx);
            });
        }

        // Add event listeners for demographics fields to update progress
        function addDemographicsListeners() {
            const demoFields = ['demo-occupation', 'demo-industry', 'demo-industry-other',
                               'demo-experience', 'demo-education', 'demo-education-other',
                               'demo-country', 'demo-expertise'];

            demoFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        updateProgressBar();
                    });
                    field.addEventListener('change', () => {
                        updateProgressBar();
                        // Auto-save demographics after change
                        if (typeof saveProgress === 'function') {
                            saveProgress();
                        }
                    });
                }
            });
        }

        // =====================================================
        // GUIDED TOUR SYSTEM
        // =====================================================
        let tourCurrentStep = 0;
        let tourActive = false;
        let tourPreviousHighlighted = null;
        let activeTourSteps = [];
        let activeTourStorageKey = '';
        let tourGeneration = 0; // increments each tour to invalidate stale timeouts

        // Tour 1: UI overview on page 1 (Demographics)
        const tour1Steps = [
            {
                target: null,
                text: 'Your survey progress is automatically saved on your device. You may refresh the page or close the browser and return later ‚Äî your progress will be retained. If you wish to restart the survey from the beginning, please use the \u201CStart Over\u201D button below.',
                position: 'center'
            },
            {
                target: '.page-indicators',
                text: 'Here you can see your progress. You can use these page indicators to navigate between pages. Completed pages are bordered in green.',
                position: 'bottom'
            },
            {
                target: function() {
                    const actions = document.querySelector('#page-1 .page-actions');
                    if (!actions) return null;
                    const prev = actions.querySelector('.btn-prev');
                    const next = actions.querySelector('.btn-next');
                    return [prev, next].filter(Boolean);
                },
                text: 'Use these buttons to navigate to the next or previous page.',
                position: 'top'
            },
            {
                target: function() {
                    const actions = document.querySelector('#page-1 .page-actions');
                    if (!actions) return null;
                    const buttons = actions.querySelectorAll('.btn');
                    for (const btn of buttons) {
                        if (btn.textContent.includes('Export')) return btn;
                    }
                    return null;
                },
                text: 'Export your survey data at any time.',
                position: 'top'
            },
            {
                target: '#submit-btn-demo',
                text: 'Survey can be only be submitted after completing all sections, but you can click this button to navigate the survey to the first missing question and get a reminder of any incomplete sections.',
                position: 'top'
            },
            {
                target: function() {
                    const actions = document.querySelector('#page-1 .page-actions');
                    if (!actions) return null;
                    return actions.querySelector('.btn-reset');
                },
                text: 'Use this with caution \u2014 it deletes all your progress and restarts the survey from scratch.',
                position: 'top'
            }
        ];

        // Tour 3: Info button on page 3 (Economic Barriers)
        const tour3Steps = [
            {
                target: function() {
                    const page = document.getElementById('page-3');
                    if (!page) return null;
                    return page.querySelector('.info-btn');
                },
                text: 'Press this button to view detailed information of the specific barrier.',
                position: 'bottom'
            }
        ];

        // Tour 2: Question flow on page 2 (Main Categories)
        const tour2Steps = [
            {
                target: function() {
                    return document.getElementById('mainCategories-continue');
                },
                text: 'After the first two questions have been answered, press this button for the comparisons questions. Be advised that once you press this button, your answers to the first two questions will be locked and you will need to unlock them to make any changes (which will reset all comparison questions i.e. Question 3 and onwards in this page).',
                position: 'top'
            }
        ];

        function shouldShowTour(storageKey) {
            return !localStorage.getItem(storageKey);
        }

        function startTour(steps, storageKey) {
            if (!shouldShowTour(storageKey)) return;

            // Invalidate any stale timeouts from a previous tour
            tourGeneration++;
            const myGeneration = tourGeneration;

            activeTourSteps = steps;
            activeTourStorageKey = storageKey;
            tourCurrentStep = 0;

            // Clear old content and hide elements BEFORE enabling tour
            const container = document.getElementById('tour-container');
            const spotlight = document.getElementById('tour-spotlight');
            const tooltip = document.getElementById('tour-tooltip');
            document.getElementById('tour-text').textContent = '';
            document.getElementById('tour-step-label').textContent = '';
            spotlight.style.cssText = 'opacity:0;';
            tooltip.style.cssText = 'opacity:0; animation:none;';

            // Now enable tour and show container
            tourActive = true;
            container.style.display = 'block';

            const dotsContainer = document.getElementById('tour-dots');
            dotsContainer.innerHTML = steps.map((_, i) =>
                `<div class="tour-dot${i === 0 ? ' active' : ''}" id="tour-dot-${i}"></div>`
            ).join('');

            setTimeout(() => {
                if (tourGeneration !== myGeneration) return; // stale, abort
                showTourStep(0);
            }, 500);
        }

        function endTour() {
            tourActive = false;
            tourGeneration++; // invalidate any pending timeouts

            if (tourPreviousHighlighted) {
                (Array.isArray(tourPreviousHighlighted) ? tourPreviousHighlighted : [tourPreviousHighlighted])
                    .forEach(el => el.classList.remove('tour-highlighted'));
                tourPreviousHighlighted = null;
            }

            // Reset sticky header z-index
            const header = document.querySelector('.sticky-header');
            if (header) header.style.zIndex = '';

            // Reset spotlight/tooltip so nothing leaks to next tour
            document.getElementById('tour-spotlight').style.cssText = '';
            document.getElementById('tour-tooltip').style.cssText = '';
            document.getElementById('tour-text').textContent = '';

            document.getElementById('tour-container').style.display = 'none';
            localStorage.setItem(activeTourStorageKey, 'true');
        }

        function advanceTour() {
            tourCurrentStep++;
            if (tourCurrentStep >= activeTourSteps.length) {
                endTour();
            } else {
                showTourStep(tourCurrentStep);
            }
        }

        function showTourStep(stepIndex, retryCount) {
            retryCount = retryCount || 0;
            const myGeneration = tourGeneration;
            const step = activeTourSteps[stepIndex];
            if (!step) { endTour(); return; }

            // Remove previous highlight
            if (tourPreviousHighlighted) {
                (Array.isArray(tourPreviousHighlighted) ? tourPreviousHighlighted : [tourPreviousHighlighted])
                    .forEach(el => el.classList.remove('tour-highlighted'));
                tourPreviousHighlighted = null;
            }

            // Manage sticky header z-index for page indicators step
            const header = document.querySelector('.sticky-header');
            if (header) header.style.zIndex = step.target === '.page-indicators' ? '4002' : '';

            // Handle centered steps with no target
            if (step.target === null) {
                positionTour(stepIndex, null);
                return;
            }

            // Resolve target element(s)
            let targetElements;
            if (typeof step.target === 'function') {
                const result = step.target();
                if (!result) {
                    if (retryCount < 3) {
                        setTimeout(() => {
                            if (tourGeneration !== myGeneration) return;
                            showTourStep(stepIndex, retryCount + 1);
                        }, 300);
                        return;
                    }
                    advanceTour(); return;
                }
                targetElements = Array.isArray(result) ? result : [result];
            } else {
                const el = document.querySelector(step.target);
                if (!el) {
                    if (retryCount < 3) {
                        setTimeout(() => {
                            if (tourGeneration !== myGeneration) return;
                            showTourStep(stepIndex, retryCount + 1);
                        }, 300);
                        return;
                    }
                    advanceTour(); return;
                }
                targetElements = [el];
            }

            // Add highlight to target(s)
            targetElements.forEach(el => el.classList.add('tour-highlighted'));
            tourPreviousHighlighted = targetElements.length === 1 ? targetElements[0] : targetElements;

            // Scroll into view if needed
            const firstRect = targetElements[0].getBoundingClientRect();
            const isInView = firstRect.top >= 0 && firstRect.bottom <= window.innerHeight;

            if (!isInView) {
                targetElements[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    if (tourGeneration !== myGeneration) return;
                    positionTour(stepIndex, targetElements);
                }, 400);
            } else {
                positionTour(stepIndex, targetElements);
            }
        }

        function getCombinedRect(elements) {
            let top = Infinity, left = Infinity, bottom = -Infinity, right = -Infinity;
            elements.forEach(el => {
                const r = el.getBoundingClientRect();
                top = Math.min(top, r.top);
                left = Math.min(left, r.left);
                bottom = Math.max(bottom, r.bottom);
                right = Math.max(right, r.right);
            });
            return { top, left, bottom, right, width: right - left, height: bottom - top };
        }

        function positionTour(stepIndex, targetElements) {
            const step = activeTourSteps[stepIndex];
            const padding = 8;
            const spotlight = document.getElementById('tour-spotlight');
            const tooltip = document.getElementById('tour-tooltip');

            if (targetElements === null) {
                // Centered step ‚Äî no spotlight cutout, just full dark overlay
                spotlight.style.top = '-10px';
                spotlight.style.left = '-10px';
                spotlight.style.width = '0px';
                spotlight.style.height = '0px';
                spotlight.style.borderRadius = '0';

                // Update tooltip content
                document.getElementById('tour-step-label').textContent = `Step ${stepIndex + 1} of ${activeTourSteps.length}`;
                document.getElementById('tour-text').textContent = step.text;

                const nextBtn = document.getElementById('tour-next-btn');
                const skipBtn = document.getElementById('tour-skip-btn');
                nextBtn.textContent = 'Next';
                skipBtn.style.display = 'inline-block';

                // Update dots
                activeTourSteps.forEach((_, i) => {
                    const dot = document.getElementById(`tour-dot-${i}`);
                    if (dot) dot.classList.toggle('active', i === stepIndex);
                });

                // Center tooltip on screen ‚Äî keep animation:none to prevent
                // tourFadeIn's transform from overriding translate(-50%,-50%)
                tooltip.classList.remove('arrow-top', 'arrow-bottom');
                tooltip.style.animation = 'none';
                tooltip.style.left = '50%';
                tooltip.style.top = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';

                spotlight.style.opacity = '1';
                tooltip.style.opacity = '1';
                return;
            }

            // Reset transform for targeted steps
            tooltip.style.transform = '';

            const rect = getCombinedRect(targetElements);

            // Position spotlight
            spotlight.style.top = (rect.top - padding) + 'px';
            spotlight.style.left = (rect.left - padding) + 'px';
            spotlight.style.width = (rect.width + padding * 2) + 'px';
            spotlight.style.height = (rect.height + padding * 2) + 'px';
            spotlight.style.borderRadius = '8px';

            // Update tooltip content
            document.getElementById('tour-step-label').textContent = `Step ${stepIndex + 1} of ${activeTourSteps.length}`;
            document.getElementById('tour-text').textContent = step.text;

            const nextBtn = document.getElementById('tour-next-btn');
            const skipBtn = document.getElementById('tour-skip-btn');
            if (stepIndex === activeTourSteps.length - 1) {
                nextBtn.textContent = 'Got it!';
                skipBtn.style.display = 'none';
            } else {
                nextBtn.textContent = 'Next';
                skipBtn.style.display = 'inline-block';
            }

            // Update dots
            activeTourSteps.forEach((_, i) => {
                const dot = document.getElementById(`tour-dot-${i}`);
                if (dot) dot.classList.toggle('active', i === stepIndex);
            });

            // Position tooltip
            tooltip.classList.remove('arrow-top', 'arrow-bottom');
            tooltip.style.animation = 'none';
            tooltip.offsetHeight; // force reflow
            tooltip.style.animation = '';

            const gap = 16;
            if (step.position === 'bottom') {
                tooltip.style.top = (rect.bottom + padding + gap) + 'px';
                tooltip.style.left = Math.max(10, rect.left) + 'px';
                tooltip.classList.add('arrow-top');
            } else {
                tooltip.style.visibility = 'hidden';
                tooltip.style.top = '0px';
                tooltip.style.left = Math.max(10, rect.left) + 'px';
                const tooltipHeight = tooltip.offsetHeight;
                tooltip.style.top = (rect.top - padding - gap - tooltipHeight) + 'px';
                tooltip.style.visibility = 'visible';
                tooltip.classList.add('arrow-bottom');
            }

            // Clamp to viewport
            const tRect = tooltip.getBoundingClientRect();
            if (tRect.right > window.innerWidth - 10) {
                tooltip.style.left = (parseFloat(tooltip.style.left) - (tRect.right - window.innerWidth + 10)) + 'px';
            }
            if (tRect.left < 10) {
                tooltip.style.left = '10px';
            }
            if (tRect.top < 10) {
                const spotBottom = parseFloat(spotlight.style.top) + parseFloat(spotlight.style.height);
                tooltip.style.top = (spotBottom + gap) + 'px';
                tooltip.classList.remove('arrow-bottom');
                tooltip.classList.add('arrow-top');
            }

            // Reveal after positioning (prevents flash of old positions)
            spotlight.style.opacity = '1';
            tooltip.style.opacity = '1';
        }

        // Reposition on resize/scroll (only if spotlight is already visible)
        function handleTourReposition() {
            if (!tourActive) return;
            const spotlight = document.getElementById('tour-spotlight');
            if (spotlight.style.opacity === '0') return; // step not shown yet
            const step = activeTourSteps[tourCurrentStep];
            if (!step) return;
            if (step.target === null) {
                positionTour(tourCurrentStep, null);
                return;
            }
            let targetElements;
            if (typeof step.target === 'function') {
                const result = step.target();
                if (!result) return;
                targetElements = Array.isArray(result) ? result : [result];
            } else {
                const el = document.querySelector(step.target);
                if (!el) return;
                targetElements = [el];
            }
            positionTour(tourCurrentStep, targetElements);
        }
        window.addEventListener('resize', handleTourReposition);
        window.addEventListener('scroll', handleTourReposition);

        // Page initialization
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize survey sections
            initSurvey();

            // Add event listeners
            addDemographicsListeners();

            // Try to load saved progress
            loadProgress();

            // Update initial progress bar state
            updateProgressBar();
        });
    </script>
    <script src="survey_app.js"></script>
</body>
</html>
